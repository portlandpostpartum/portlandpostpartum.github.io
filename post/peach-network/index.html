<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=hugo-theme content="Axiom 0.6.8"><link rel=icon type=image/png sizes=32x32 href=/image/brand/favicon.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon href=/image/brand/icon-1-1.png><link rel=canonical href=https://pdxjohnny.github.io/post/peach-network/><link rel=preload as=style href="/bundle.css?v=1594149815" media=all><link rel=stylesheet href="/bundle.css?v=1594149815" media=all><style>.cdata pre{color:#edf2f7;background-color:#2d3748}.cdata :not(pre)>code{color:#805ad5;background-color:#f7fafc}.chroma .err{color:#fed7d7;background-color:#9b2c2c}.chroma .hl{background-color:#4a5568}.chroma .ln{color:#a0aec0}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#63b3ed}.chroma .kt{color:#b794f4}.chroma .na{color:#f6e05e}.chroma .nb{color:#f6ad55}.chroma .nc{color:#fc8181}.chroma .no{color:#68d391}.chroma .nd{color:#fc8181}.chroma .ne{color:#fc8181}.chroma .nf{color:#f6ad55}.chroma .nt{color:#fc8181}.chroma .l{color:#b794f4}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#68d391}.chroma .se{color:#a0aec0}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#68d391}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#b794f4}.chroma .o,.chroma .ow{color:#90cdf4}.chroma .p{color:#cbd5e0}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs{color:#a0aec0}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}</style><title>Fuzzing network applications with peach : pdxjohnny's blog</title><meta property="og:title" content="Fuzzing network applications with peach"><meta property="og:site_name" content="pdxjohnny's blog"><meta property="og:url" content="https://pdxjohnny.github.io/post/peach-network/"><link rel=image_src href=https://pdxjohnny.github.io/image/page-default.webp><meta property="og:image" content="https://pdxjohnny.github.io/image/page-default.webp"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="og:type" content="article"><meta property="og:locale" content="en_us"><meta property="og:description" content="So you want to fuzz network applications with peach eh? Well you've come to the right place. This is a tutorial on how to get you fuzzing TCP applications, without TLS/SSL enabled. If you want to fuzz UDP or an application which only communicates via TLS/SSL then this is a great place for you to start, however it will not answer all your questions."><meta name=description content="So you want to fuzz network applications with peach eh? Well you've come to the right place. This is a tutorial on how to get you fuzzing TCP applications, without TLS/SSL enabled. If you want to fuzz UDP or an application which only communicates via TLS/SSL then this is a great place for you to start, however it will not answer all your questions."><meta property="og:updated_time" content="2016-08-10T20:35:13Z"><meta property="fb:app_id" content><meta name=author content="John Andersen"><meta property="article:author" content="https://pdxjohnny.github.io/"><meta property="article:published_time" content="2016-08-10T20:35:13Z"><meta property="article:modified_time" content="2016-08-10T20:35:13Z"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Fuzzing network applications with peach","alternativeHeadline":"So you want to fuzz network applications with peach eh? Well you've come to the right place. This is a tutorial on how to get you fuzzing TCP applications, without TLS/SSL enabled. If you want to fuzz UDP or an application which only communicates via TLS/SSL then this is a great place for you to start, however it will not answer all your questions.","url":"https://pdxjohnny.github.io/post/peach-network/","image":"https://pdxjohnny.github.io/image/page-default.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://pdxjohnny.github.io/post/peach-network/"},"description":"So you want to fuzz network applications with peach eh? Well you've come to the right place. This is a tutorial on how to get you fuzzing TCP applications, without TLS/SSL enabled. If you want to fuzz UDP or an application which only communicates via TLS/SSL then this is a great place for you to start, however it will not answer all your questions.","author":{"@type":"Person","name":"John Andersen"},"publisher":{"@type":"Organization","name":"pdxjohnny's blog","logo":{"@type":"ImageObject","url":"https://pdxjohnny.github.io/image/brand/icon-1-1.png"}},"datePublished":"2016-08-10T20:35:13Z","dateModified":"2016-08-10T20:35:13Z","articleBody":"\u003cp\u003eSo you want to fuzz network applications with peach eh? Well you've come to the\nright place. This is a tutorial on how to get you fuzzing TCP applications,\nwithout TLS/SSL enabled. If you want to fuzz UDP or an application which only\ncommunicates via TLS/SSL then this is a great place for you to start, however it\nwill not answer all your questions. I will point you in the right direction at\nthe end of this post.\u003c/p\u003e\n\u003cp\u003eThe first step in fuzzing is to understand the structure of the protocol. It\noften helps to have an example of this structure. Therefore we will be\ncapturing the data of our target and simply playing it back. If you were to\nspend more time, which you should, then you would make data models in peach\nwhich contain specific fields rather than the blob we will be using.\u003c/p\u003e\n\u003cp\u003eThe two most well known ways of getting network traffic are tcpdump and\nwireshark. Peach can use input from a file for the data model and mutate it. We\nare going to use a tiny tool I wrote to capture the conversations back and\nforth rather than telling you to open tcpdump / wireshark and copy paste to a\nfile. If you would rather do that be my guest.\u003c/p\u003e\n\u003ch2 id=\"enter-convo-capture\"\u003eEnter convo-capture\u003c/h2\u003e\n\u003cp\u003eThis saves the TCP conversation to files. Give it the port and host it needs to\nbe monitoring. This is especially useful for fuzzing with peach on TCP based\nprograms so that you don't have to go into wireshark to capture then copy paste\nthe data from each sequence of packets. This will take all packets and put them\nin a file until the other endpoint sends data. Then it will increment the\nnumber on the exchange and write the data to that exchanges file.\u003c/p\u003e\n\u003cp\u003eThe binary has been built and included in the gist for your convenience.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eBy no means do I condone putting binaries in git repos but I know not\neveryone has the go toolchain. You need libpcap and libpthread to run it.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eBuilding will use sudo because it will \u003ccode\u003eset_cap_raw\u003c/code\u003e on convo-capture. If you\ndon't want to set this then you have to run convo-capture as root.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003egit clone https://gist.github.com/pdxjohnny/e2d1df77e81f07254da192fe1bc568a0 convo-capture\n\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e !$\n./build.sh\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow you can move it to bin if you want or run it prepended with ./ from the\ndirectory you built it.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003esudo mv convo-capture /usr/bin/convo-capture\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003ePersonally I like to put things in ~/.local/bin/ but do as you will\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWe are now ready to capture packets. Keep in mind that convo-capture will not\nwrite over files that you have previously captured if they are in the directory\nyou are working in. Be sure to delete files from previous captures or change to\na new directory.\u003c/p\u003e\n\u003cp\u003eLet's try to capture HTTP traffic using curl and python3's http.server\n(SimpleHTTPServer in python2). First we need to ssh to another computer and\nstart an HTTP server or we can start one on our local machine. If you start one\non your machine then everywhere you see example.com replace it with localhost\nand add \u003ccode\u003e-i lo\u003c/code\u003e to convo-capture for capturing on the loopback interface.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003epdxjohnny@pdxjohnny convo-capture\u003cspan class=\"o\"\u003e]\u003c/span\u003e$ ssh example.com\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epdxjohnny@example.com ~\u003cspan class=\"o\"\u003e]\u003c/span\u003e$ python3 -m http.server \u003cspan class=\"m\"\u003e4444\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow that we have a HTTP server running lets start convo-capture.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# For localhost add -i lo\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# convo-capture -p 4444 -ip localhost -i lo -v\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epdxjohnny@pdxjohnny convo-capture\u003cspan class=\"o\"\u003e]\u003c/span\u003e$ convo-capture -p \u003cspan class=\"m\"\u003e4444\u003c/span\u003e -ip example.com -v\nCapturing TCP port \u003cspan class=\"m\"\u003e4444\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e host example.com\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOk great we are now capturing all traffic going to example.com on port 4444 from\nour computer and from example.com port 4444 back to our computer.\nNow we just need to use curl to generate a request we can capture.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ecurl -v http://example.com:4444/file\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRequest sent! Look back at the session running convo-capture, you should see\nthat the output you observed in curl has been captured (expect for the \u0026lt; and \u0026gt;\nleft of the headers, curl adds those).\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-log\" data-lang=\"log\"\u003e[pdxjohnny@pdxjohnny convo-capture]$ convo-capture -p 4444 -ip example.com -v\nCapturing TCP port 4444 for host example.com\nGET /file HTTP/1.1\nHost: example.com:4444\nUser-Agent: curl/7.47.0\nAccept: */*\n\nHTTP/1.0 200 OK\nServer: SimpleHTTP/0.6 Python/3.4.2\nDate: Wed, 10 Aug 2016 16:38:42 GMT\nContent-type: text/plain\nContent-Length: 514\nLast-Modified: Tue, 26 Jul 2016 14:43:05 GMT\n\nYo this is the file\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNow you can ctrl-c to stop the capture. As you can see we captured the\nconversation from our local machine to the remote host and the response the\nremote host sent us. If you do an ls you will also see the files that were\ncreated by this capture.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-log\" data-lang=\"log\"\u003e[pdxjohnny@pdxjohnny convo-capture]$ ls -lAF\ntotal 5752\n... Aug 10 09:34 10.7.202.149-\u0026gt;10.7.202.78-0\n... Aug 10 09:34 10.7.202.78-\u0026gt;10.7.202.149-0\n... Aug 10 08:35 build.sh*\n... Aug 10 09:17 convo-capture*\n... Aug 10 09:33 .git/\n... Aug 10 09:16 .gitignore\n... Aug 10 09:15 main.go\n... Aug 10 09:58 README.md\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003ecating the files will make convo-capture's usefulness apparent.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-log\" data-lang=\"log\"\u003e[pdxjohnny@pdxjohnny convo-capture]$ cat 10.7.202.149-\u0026gt;10.7.202.78-0\nGET /file HTTP/1.1\nHost: example.com:4444\nUser-Agent: curl/7.47.0\nAccept: */*\n\n[pdxjohnny@pdxjohnny convo-capture]$ cat 10.7.202.78-\u0026gt;10.7.202.149-0\nHTTP/1.0 200 OK\nServer: SimpleHTTP/0.6 Python/3.4.2\nDate: Wed, 10 Aug 2016 16:38:42 GMT\nContent-type: text/plain\nContent-Length: 514\nLast-Modified: Tue, 26 Jul 2016 14:43:05 GMT\n\nYo this is the file\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAs you can see it has assembled the packets into files based on the order they\nwere sent in. For me the second file, the servers reply, was two packets.\nconvo-capture saw the two packets in a row from the server to client and said\nok this is all part of one message I'm going to save it to a file as such. A\nmessage is a continuous sequence of packets ended when the other side starts\nsending a message. The more messages that are collected the more files you will\nsee after you kill convo-capture.\u003c/p\u003e\n\u003cp\u003eThere was only one back and forth so they are both 0 in the sequence. If you\nwere to have ran curl twice with convo-capture running then you would see the\ncontents of 0 repeated in 1.\u003c/p\u003e\n\u003cp\u003eThis is very useful for fuzzing with peach. Peach allows us to order our call\nand response to the target program. For example say you want to fuzz something\nlike git. git is not a simple call and response. It has an exchange of call,\nresponse, call, response for a clone. Let's walk through how you would use\nconvo-capture to fuzz the git protocol with peach.\u003c/p\u003e\n\u003ch2 id=\"capturing-the-git-protocol\"\u003eCapturing the git protocol\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://asciinema.org/a/7xd0u4u0vfv7n7s7gq4f0zdg2\"\u003e\u003cimg src=\"https://asciinema.org/a/7xd0u4u0vfv7n7s7gq4f0zdg2.png\" alt=\"asciicast\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThis video goes shows the how to capture the data involved in a git clone\nover the git protocol. Use it as a reference if you are having trouble with\nthe steps below.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eLet's take a stroll on over to tmp so we don't create a bunch of useless files.\nWe'll make a directory there to play in.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003emkdir /tmp/demo\n\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/demo\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eMake a few directories so nothing writes over each other. Then well make a git\nrepo and populate it with some files.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003emkdir clonedir capture\nmkdir testrepo\n\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e testrepo\ncat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt; README.md\n\u003c/span\u003e\u003cspan class=\"s\"\u003eThis is a super cool test repo\n\u003c/span\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\ngit init\ngit add -A\ngit commit -sam \u003cspan class=\"s1\"\u003e\u0026#39;Added README.md\u0026#39;\u003c/span\u003e\n\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e ..\n\u003cspan class=\"c1\"\u003e# You should now be back in /tmp/demo\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe have our testrepo, now lets create a bare copy of it to be served by \u003ca href=\"https://git-scm.com/book/en/v1/Git-on-the-Server-Git-Daemon\"\u003egit\ndaemon\u003c/a\u003e. This requires that we make the \u003ccode\u003egit-daemon-export-ok\u003c/code\u003e file\nas well. Then we will start the git server.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003egit clone --bare testrepo testrepo.git\ntouch testrepo.git/git-daemon-export-ok\ngit daemon --reuseaddr --base-path\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PWD\u003c/span\u003e \u003cspan class=\"nv\"\u003e$PWD\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# PWD is faster than typing /tmp/demo\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eGreat! The git server is up! We can look up what port it is running on, but\nif perhaps we were fuzzing something we didn't know we would have to find out.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# Apparently netstat is depricated, so let\u0026#39;s use ss\u003c/span\u003e\nss -ltnp \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep git\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAlright its port 9418. In another shell go to the capture directory and start\nconvo-capture.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/demo/capture\nconvo-capture -p \u003cspan class=\"m\"\u003e9418\u003c/span\u003e -i lo\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eCapture is running, git server is up, all that's left is to go to clonedir and\nwatch the magic happen.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/demo/clonedir\ngit clone git://localhost/testrepo.git\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow switch back to the shell running convo-capture and hit it will ctrl-c. You\nshould see four files in the capture directory. We are going to fuzz the git\nclient so right now we are interested in the files which go from port 9418 to\nsome other port.\u003c/p\u003e\n\u003ch2 id=\"using-our-captured-data-to-fuzz-with-peach\"\u003eUsing our captured data to fuzz with peach\u003c/h2\u003e\n\u003cp\u003eYou should usually test against the master branch or the latest version of\nwhatever you are fuzzing. You don't want to waste time finding something which\nhas already been fixed. This is why we are going to build git from source. Of\ncourse you don't have to do this. But if you have never built something from\nsource it would be good practice.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://asciinema.org/a/82390\"\u003e\u003cimg src=\"https://asciinema.org/a/82390.png\" alt=\"asciicast\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThis video shows the peach process. You probably want to skip past the\npart were we run make on git.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eNow that we know what the git server is sending to the client we could either\nfuzz the server or the client. The client is easy because it exits after\ncloning were as the server stays up to serve requests.\u003c/p\u003e\n\u003cp\u003eWe are going to compile git from source so we need to download its\ndependencies.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003esudo apt-get -y install libcurl4-gnutls-dev libexpat1-dev gettext \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  libz-dev libssl-dev \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  \u003cspan class=\"o\"\u003e||\u003c/span\u003e sudo yum install curl-devel expat-devel gettext-devel \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  openssl-devel perl-devel zlib-devel\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we are going to clone git build it and install it.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003emkdir -p /tmp/demo/\n\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/demo/\ngit clone --depth\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e https://github.com/git/git\n\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/demo/git/\n\u003cspan class=\"c1\"\u003e# I found that the latest git doesn\u0026#39;t cooperate unless I install it\u003c/span\u003e\nsudo make install\ngit --version\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eGit is installed, now lets copy our relevant captures to a testing directory.\nHere we clone the repo for this post and copy the git.xml file out of it. But\nyou could of course make your own or modify the one here.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/demo/\nmkdir gitfuzzy\n\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e gitfuzzy\ncp /tmp/demo/capture/\u003cspan class=\"se\"\u003e\\:\\:\u003c/span\u003e1\u003cspan class=\"se\"\u003e\\:\u003c/span\u003e9418-\u003cspan class=\"se\"\u003e\\\u0026gt;\u003c/span\u003e* ./\ngit clone https://gist.github.com/pdxjohnny/e2d1df77e81f07254da192fe1bc568a0 t\ncp t/git.xml ./\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ccode\u003egit.xml\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-xml\" data-lang=\"xml\"\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;utf-8\u0026#34;?\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;Peach\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;DataModel\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;TheDataModel\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Blob/\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/DataModel\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;StateModel\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;TheState\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003einitialState=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Initial\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;State\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Initial\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Action\u003c/span\u003e \u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;accept\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e\u0026lt;!-- receive bytes --\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Action\u003c/span\u003e \u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;input\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;DataModel\u003c/span\u003e \u003cspan class=\"na\"\u003eref=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;TheDataModel\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;/Action\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e\u0026lt;!-- send bytes --\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Action\u003c/span\u003e \u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;output\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;DataModel\u003c/span\u003e \u003cspan class=\"na\"\u003eref=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;TheDataModel\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"c\"\u003e\u0026lt;!-- Change this to be whatever port your git client was on --\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;Data\u003c/span\u003e \u003cspan class=\"na\"\u003efileName=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;::1:9418-\u0026gt;::1:58226-0\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;/Action\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e\u0026lt;!-- receive bytes --\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Action\u003c/span\u003e \u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;input\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;DataModel\u003c/span\u003e \u003cspan class=\"na\"\u003eref=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;TheDataModel\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;/Action\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e\u0026lt;!-- send bytes --\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Action\u003c/span\u003e \u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;output\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;DataModel\u003c/span\u003e \u003cspan class=\"na\"\u003eref=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;TheDataModel\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"c\"\u003e\u0026lt;!-- Change this to be whatever port your git client was on --\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;Data\u003c/span\u003e \u003cspan class=\"na\"\u003efileName=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;::1:9418-\u0026gt;::1:58226-1\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;/Action\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/State\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/StateModel\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;Agent\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;LinAgent\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"c\"\u003e\u0026lt;!-- Register for core file notifications. --\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Monitor\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;LinuxDebugger\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e\u0026lt;!-- This is the program we\u0026#39;re going to run inside of the debugger --\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Param\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Executable\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;git\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e\u0026lt;!-- These are arguments to the executable we want to run --\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Param\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Arguments\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;clone git://127.0.0.1/testrepo.git\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e\u0026lt;!-- This parameter will cause the monitor to terminate the process\n\u003c/span\u003e\u003cspan class=\"c\"\u003e\t\t\t\t\t\t\t\t once the CPU usage reaches zero. --\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Param\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;CpuKill\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/Monitor\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Monitor\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;CleanupFolder\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Param\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Folder\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;testrepo\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/Monitor\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/Agent\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;Test\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Default\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Agent\u003c/span\u003e \u003cspan class=\"na\"\u003eref=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;LinAgent\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003eplatform=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;linux\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;StateModel\u003c/span\u003e \u003cspan class=\"na\"\u003eref=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;TheState\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Publisher\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;TcpListener\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Param\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Interface\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;127.0.0.1\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Param\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Port\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;9418\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/Publisher\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Strategy\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Random\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Logger\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Filesystem\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Param\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Path\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;logs\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/Logger\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/Test\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/Peach\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYour git client used a different port to connect to the git server when we did\nthe capture than mine did. When you copy the xml file you will have to change\nthe values as indicated with comments so that peach knows what files to use.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# Change to the correct files\u003c/span\u003e\nvim git.xml\npeach git.xml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePeach is fuzzing the git protocol now! Good job you rock!\u003c/p\u003e"}</script><link rel=preload as=script href="/bundle.js?v=1594149815"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://stats.g.doubleclick.net><link rel=preconnect href=https://www.googleadservices.com><link rel=preload as=script href="https://www.googletagmanager.com/gtag/js?id=UA-160259978-2"><script src="https://www.googletagmanager.com/gtag/js?id=UA-160259978-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-160259978-2');</script></head><body><header id=nav class=header><div class="ax-l-i max-w-6xl"><div class=ax-logo><a class=block href=/ title="pdxjohnny's blog"><img src=/images/avatar@2x.png alt="pdxjohnny's blog"></a></div><div class=ax-user><a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target=_blank rel="noopener nofollow" href="https://www.google.com/search?q=site:chadig.com" title=Search><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33.0 002.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg></a><a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href=/about/>About</a></div></div></header><main><div class=default-single><div class="ax-title ax-l-o"><div class="ax-l-i max-w-680"><h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Fuzzing network applications with peach</h1><div class="ax-meta flex items-center mt-5"><div class="flex-grow min-w-0"><div class="flex items-center"><div class=flex-shrink-0><img class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-05 rounded-full border border-blue-300" src=/images/avatar@2x.png alt="John Andersen"></div><div class="flex-shrink-0 ml-2 leading-tight font-content-sans"><a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target=_blank rel="noopener nofollow" title="John Andersen" href=https://pdxjohnny.github.io/>John Andersen</a>
<time class="text-sm text-raven-500" datetime=2016-08-10T20:35:13Z>Aug 10, 2016 1:35PM</time></div></div></div><div><div class="flex items-center"><a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Fuzzing%20network%20applications%20with%20peach%20by%20%40pdxjohnny%20https%3a%2f%2fpdxjohnny.github.io%2fpost%2fpeach-network%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2fpdxjohnny.github.io%2fpost%2fpeach-network%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234.0H1.765C.8.001.0.79.0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766.0 3.284.13 3.726.2v4.32h-2.543c-2.006.0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21.0 30.234.0z"/></svg></a></div></div></div></div></div><div class="ax-content ax-l-o"><div class="ax-l-i max-w-680"><article class=cdata><p>So you want to fuzz network applications with peach eh? Well you've come to the
right place. This is a tutorial on how to get you fuzzing TCP applications,
without TLS/SSL enabled. If you want to fuzz UDP or an application which only
communicates via TLS/SSL then this is a great place for you to start, however it
will not answer all your questions. I will point you in the right direction at
the end of this post.</p><p>The first step in fuzzing is to understand the structure of the protocol. It
often helps to have an example of this structure. Therefore we will be
capturing the data of our target and simply playing it back. If you were to
spend more time, which you should, then you would make data models in peach
which contain specific fields rather than the blob we will be using.</p><p>The two most well known ways of getting network traffic are tcpdump and
wireshark. Peach can use input from a file for the data model and mutate it. We
are going to use a tiny tool I wrote to capture the conversations back and
forth rather than telling you to open tcpdump / wireshark and copy paste to a
file. If you would rather do that be my guest.</p><h2 id=enter-convo-capture>Enter convo-capture</h2><p>This saves the TCP conversation to files. Give it the port and host it needs to
be monitoring. This is especially useful for fuzzing with peach on TCP based
programs so that you don't have to go into wireshark to capture then copy paste
the data from each sequence of packets. This will take all packets and put them
in a file until the other endpoint sends data. Then it will increment the
number on the exchange and write the data to that exchanges file.</p><p>The binary has been built and included in the gist for your convenience.</p><blockquote><p>By no means do I condone putting binaries in git repos but I know not
everyone has the go toolchain. You need libpcap and libpthread to run it.</p></blockquote><p>Building will use sudo because it will <code>set_cap_raw</code> on convo-capture. If you
don't want to set this then you have to run convo-capture as root.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone https://gist.github.com/pdxjohnny/e2d1df77e81f07254da192fe1bc568a0 convo-capture
<span class=nb>cd</span> !$
./build.sh
</code></pre></div><p>Now you can move it to bin if you want or run it prepended with ./ from the
directory you built it.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo mv convo-capture /usr/bin/convo-capture
</code></pre></div><blockquote><p>Personally I like to put things in ~/.local/bin/ but do as you will</p></blockquote><p>We are now ready to capture packets. Keep in mind that convo-capture will not
write over files that you have previously captured if they are in the directory
you are working in. Be sure to delete files from previous captures or change to
a new directory.</p><p>Let's try to capture HTTP traffic using curl and python3's http.server
(SimpleHTTPServer in python2). First we need to ssh to another computer and
start an HTTP server or we can start one on our local machine. If you start one
on your machine then everywhere you see example.com replace it with localhost
and add <code>-i lo</code> to convo-capture for capturing on the loopback interface.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=o>[</span>pdxjohnny@pdxjohnny convo-capture<span class=o>]</span>$ ssh example.com
<span class=o>[</span>pdxjohnny@example.com ~<span class=o>]</span>$ python3 -m http.server <span class=m>4444</span>
</code></pre></div><p>Now that we have a HTTP server running lets start convo-capture.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># For localhost add -i lo</span>
<span class=c1># convo-capture -p 4444 -ip localhost -i lo -v</span>
<span class=o>[</span>pdxjohnny@pdxjohnny convo-capture<span class=o>]</span>$ convo-capture -p <span class=m>4444</span> -ip example.com -v
Capturing TCP port <span class=m>4444</span> <span class=k>for</span> host example.com
</code></pre></div><p>Ok great we are now capturing all traffic going to example.com on port 4444 from
our computer and from example.com port 4444 back to our computer.
Now we just need to use curl to generate a request we can capture.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -v http://example.com:4444/file
</code></pre></div><p>Request sent! Look back at the session running convo-capture, you should see
that the output you observed in curl has been captured (expect for the &lt; and >
left of the headers, curl adds those).</p><pre><code class=language-log data-lang=log>[pdxjohnny@pdxjohnny convo-capture]$ convo-capture -p 4444 -ip example.com -v
Capturing TCP port 4444 for host example.com
GET /file HTTP/1.1
Host: example.com:4444
User-Agent: curl/7.47.0
Accept: */*

HTTP/1.0 200 OK
Server: SimpleHTTP/0.6 Python/3.4.2
Date: Wed, 10 Aug 2016 16:38:42 GMT
Content-type: text/plain
Content-Length: 514
Last-Modified: Tue, 26 Jul 2016 14:43:05 GMT

Yo this is the file
</code></pre><p>Now you can ctrl-c to stop the capture. As you can see we captured the
conversation from our local machine to the remote host and the response the
remote host sent us. If you do an ls you will also see the files that were
created by this capture.</p><pre><code class=language-log data-lang=log>[pdxjohnny@pdxjohnny convo-capture]$ ls -lAF
total 5752
... Aug 10 09:34 10.7.202.149-&gt;10.7.202.78-0
... Aug 10 09:34 10.7.202.78-&gt;10.7.202.149-0
... Aug 10 08:35 build.sh*
... Aug 10 09:17 convo-capture*
... Aug 10 09:33 .git/
... Aug 10 09:16 .gitignore
... Aug 10 09:15 main.go
... Aug 10 09:58 README.md
</code></pre><p>cating the files will make convo-capture's usefulness apparent.</p><pre><code class=language-log data-lang=log>[pdxjohnny@pdxjohnny convo-capture]$ cat 10.7.202.149-&gt;10.7.202.78-0
GET /file HTTP/1.1
Host: example.com:4444
User-Agent: curl/7.47.0
Accept: */*

[pdxjohnny@pdxjohnny convo-capture]$ cat 10.7.202.78-&gt;10.7.202.149-0
HTTP/1.0 200 OK
Server: SimpleHTTP/0.6 Python/3.4.2
Date: Wed, 10 Aug 2016 16:38:42 GMT
Content-type: text/plain
Content-Length: 514
Last-Modified: Tue, 26 Jul 2016 14:43:05 GMT

Yo this is the file
</code></pre><p>As you can see it has assembled the packets into files based on the order they
were sent in. For me the second file, the servers reply, was two packets.
convo-capture saw the two packets in a row from the server to client and said
ok this is all part of one message I'm going to save it to a file as such. A
message is a continuous sequence of packets ended when the other side starts
sending a message. The more messages that are collected the more files you will
see after you kill convo-capture.</p><p>There was only one back and forth so they are both 0 in the sequence. If you
were to have ran curl twice with convo-capture running then you would see the
contents of 0 repeated in 1.</p><p>This is very useful for fuzzing with peach. Peach allows us to order our call
and response to the target program. For example say you want to fuzz something
like git. git is not a simple call and response. It has an exchange of call,
response, call, response for a clone. Let's walk through how you would use
convo-capture to fuzz the git protocol with peach.</p><h2 id=capturing-the-git-protocol>Capturing the git protocol</h2><p><a href=https://asciinema.org/a/7xd0u4u0vfv7n7s7gq4f0zdg2><img src=https://asciinema.org/a/7xd0u4u0vfv7n7s7gq4f0zdg2.png alt=asciicast></a></p><blockquote><p>This video goes shows the how to capture the data involved in a git clone
over the git protocol. Use it as a reference if you are having trouble with
the steps below.</p></blockquote><p>Let's take a stroll on over to tmp so we don't create a bunch of useless files.
We'll make a directory there to play in.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir /tmp/demo
<span class=nb>cd</span> /tmp/demo
</code></pre></div><p>Make a few directories so nothing writes over each other. Then well make a git
repo and populate it with some files.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir clonedir capture
mkdir testrepo
<span class=nb>cd</span> testrepo
cat <span class=s>&lt;&lt; EOF &gt; README.md
</span><span class=s>This is a super cool test repo
</span><span class=s>EOF</span>
git init
git add -A
git commit -sam <span class=s1>&#39;Added README.md&#39;</span>
<span class=nb>cd</span> ..
<span class=c1># You should now be back in /tmp/demo</span>
</code></pre></div><p>We have our testrepo, now lets create a bare copy of it to be served by <a href=https://git-scm.com/book/en/v1/Git-on-the-Server-Git-Daemon>git
daemon</a>. This requires that we make the <code>git-daemon-export-ok</code> file
as well. Then we will start the git server.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone --bare testrepo testrepo.git
touch testrepo.git/git-daemon-export-ok
git daemon --reuseaddr --base-path<span class=o>=</span><span class=nv>$PWD</span> <span class=nv>$PWD</span>
<span class=c1># PWD is faster than typing /tmp/demo</span>
</code></pre></div><p>Great! The git server is up! We can look up what port it is running on, but
if perhaps we were fuzzing something we didn't know we would have to find out.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Apparently netstat is depricated, so let&#39;s use ss</span>
ss -ltnp <span class=p>|</span> grep git
</code></pre></div><p>Alright its port 9418. In another shell go to the capture directory and start
convo-capture.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /tmp/demo/capture
convo-capture -p <span class=m>9418</span> -i lo
</code></pre></div><p>Capture is running, git server is up, all that's left is to go to clonedir and
watch the magic happen.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /tmp/demo/clonedir
git clone git://localhost/testrepo.git
</code></pre></div><p>Now switch back to the shell running convo-capture and hit it will ctrl-c. You
should see four files in the capture directory. We are going to fuzz the git
client so right now we are interested in the files which go from port 9418 to
some other port.</p><h2 id=using-our-captured-data-to-fuzz-with-peach>Using our captured data to fuzz with peach</h2><p>You should usually test against the master branch or the latest version of
whatever you are fuzzing. You don't want to waste time finding something which
has already been fixed. This is why we are going to build git from source. Of
course you don't have to do this. But if you have never built something from
source it would be good practice.</p><p><a href=https://asciinema.org/a/82390><img src=https://asciinema.org/a/82390.png alt=asciicast></a></p><blockquote><p>This video shows the peach process. You probably want to skip past the
part were we run make on git.</p></blockquote><p>Now that we know what the git server is sending to the client we could either
fuzz the server or the client. The client is easy because it exits after
cloning were as the server stays up to serve requests.</p><p>We are going to compile git from source so we need to download its
dependencies.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo apt-get -y install libcurl4-gnutls-dev libexpat1-dev gettext <span class=se>\
</span><span class=se></span>  libz-dev libssl-dev <span class=se>\
</span><span class=se></span>  <span class=o>||</span> sudo yum install curl-devel expat-devel gettext-devel <span class=se>\
</span><span class=se></span>  openssl-devel perl-devel zlib-devel
</code></pre></div><p>Now we are going to clone git build it and install it.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir -p /tmp/demo/
<span class=nb>cd</span> /tmp/demo/
git clone --depth<span class=o>=</span><span class=m>1</span> https://github.com/git/git
<span class=nb>cd</span> /tmp/demo/git/
<span class=c1># I found that the latest git doesn&#39;t cooperate unless I install it</span>
sudo make install
git --version
</code></pre></div><p>Git is installed, now lets copy our relevant captures to a testing directory.
Here we clone the repo for this post and copy the git.xml file out of it. But
you could of course make your own or modify the one here.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /tmp/demo/
mkdir gitfuzzy
<span class=nb>cd</span> gitfuzzy
cp /tmp/demo/capture/<span class=se>\:\:</span>1<span class=se>\:</span>9418-<span class=se>\&gt;</span>* ./
git clone https://gist.github.com/pdxjohnny/e2d1df77e81f07254da192fe1bc568a0 t
cp t/git.xml ./
</code></pre></div><p><code>git.xml</code></p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class=nt>&lt;Peach&gt;</span>
    <span class=nt>&lt;DataModel</span> <span class=na>name=</span><span class=s>&#34;TheDataModel&#34;</span><span class=nt>&gt;</span>
        <span class=nt>&lt;Blob/&gt;</span>
    <span class=nt>&lt;/DataModel&gt;</span>
    <span class=nt>&lt;StateModel</span> <span class=na>name=</span><span class=s>&#34;TheState&#34;</span> <span class=na>initialState=</span><span class=s>&#34;Initial&#34;</span><span class=nt>&gt;</span>
        <span class=nt>&lt;State</span> <span class=na>name=</span><span class=s>&#34;Initial&#34;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;Action</span> <span class=na>type=</span><span class=s>&#34;accept&#34;</span><span class=nt>/&gt;</span>
            <span class=c>&lt;!-- receive bytes --&gt;</span>
            <span class=nt>&lt;Action</span> <span class=na>type=</span><span class=s>&#34;input&#34;</span><span class=nt>&gt;</span>
                <span class=nt>&lt;DataModel</span> <span class=na>ref=</span><span class=s>&#34;TheDataModel&#34;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;/Action&gt;</span>
            <span class=c>&lt;!-- send bytes --&gt;</span>
            <span class=nt>&lt;Action</span> <span class=na>type=</span><span class=s>&#34;output&#34;</span><span class=nt>&gt;</span>
                <span class=nt>&lt;DataModel</span> <span class=na>ref=</span><span class=s>&#34;TheDataModel&#34;</span><span class=nt>/&gt;</span>
                <span class=c>&lt;!-- Change this to be whatever port your git client was on --&gt;</span>
                <span class=nt>&lt;Data</span> <span class=na>fileName=</span><span class=s>&#34;::1:9418-&gt;::1:58226-0&#34;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;/Action&gt;</span>
            <span class=c>&lt;!-- receive bytes --&gt;</span>
            <span class=nt>&lt;Action</span> <span class=na>type=</span><span class=s>&#34;input&#34;</span><span class=nt>&gt;</span>
                <span class=nt>&lt;DataModel</span> <span class=na>ref=</span><span class=s>&#34;TheDataModel&#34;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;/Action&gt;</span>
            <span class=c>&lt;!-- send bytes --&gt;</span>
            <span class=nt>&lt;Action</span> <span class=na>type=</span><span class=s>&#34;output&#34;</span><span class=nt>&gt;</span>
                <span class=nt>&lt;DataModel</span> <span class=na>ref=</span><span class=s>&#34;TheDataModel&#34;</span><span class=nt>/&gt;</span>
                <span class=c>&lt;!-- Change this to be whatever port your git client was on --&gt;</span>
                <span class=nt>&lt;Data</span> <span class=na>fileName=</span><span class=s>&#34;::1:9418-&gt;::1:58226-1&#34;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;/Action&gt;</span>
        <span class=nt>&lt;/State&gt;</span>
    <span class=nt>&lt;/StateModel&gt;</span>
    <span class=nt>&lt;Agent</span> <span class=na>name=</span><span class=s>&#34;LinAgent&#34;</span><span class=nt>&gt;</span>
        <span class=c>&lt;!-- Register for core file notifications. --&gt;</span>
        <span class=nt>&lt;Monitor</span> <span class=na>class=</span><span class=s>&#34;LinuxDebugger&#34;</span><span class=nt>&gt;</span>
            <span class=c>&lt;!-- This is the program we&#39;re going to run inside of the debugger --&gt;</span>
            <span class=nt>&lt;Param</span> <span class=na>name=</span><span class=s>&#34;Executable&#34;</span> <span class=na>value=</span><span class=s>&#34;git&#34;</span><span class=nt>/&gt;</span>
            <span class=c>&lt;!-- These are arguments to the executable we want to run --&gt;</span>
            <span class=nt>&lt;Param</span> <span class=na>name=</span><span class=s>&#34;Arguments&#34;</span> <span class=na>value=</span><span class=s>&#34;clone git://127.0.0.1/testrepo.git&#34;</span><span class=nt>/&gt;</span>
            <span class=c>&lt;!-- This parameter will cause the monitor to terminate the process
</span><span class=c>								 once the CPU usage reaches zero. --&gt;</span>
            <span class=nt>&lt;Param</span> <span class=na>name=</span><span class=s>&#34;CpuKill&#34;</span> <span class=na>value=</span><span class=s>&#34;true&#34;</span><span class=nt>/&gt;</span>
        <span class=nt>&lt;/Monitor&gt;</span>
        <span class=nt>&lt;Monitor</span> <span class=na>class=</span><span class=s>&#34;CleanupFolder&#34;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;Param</span> <span class=na>name=</span><span class=s>&#34;Folder&#34;</span> <span class=na>value=</span><span class=s>&#34;testrepo&#34;</span><span class=nt>/&gt;</span>
        <span class=nt>&lt;/Monitor&gt;</span>
    <span class=nt>&lt;/Agent&gt;</span>
    <span class=nt>&lt;Test</span> <span class=na>name=</span><span class=s>&#34;Default&#34;</span><span class=nt>&gt;</span>
        <span class=nt>&lt;Agent</span> <span class=na>ref=</span><span class=s>&#34;LinAgent&#34;</span> <span class=na>platform=</span><span class=s>&#34;linux&#34;</span><span class=nt>/&gt;</span>
        <span class=nt>&lt;StateModel</span> <span class=na>ref=</span><span class=s>&#34;TheState&#34;</span><span class=nt>/&gt;</span>
        <span class=nt>&lt;Publisher</span> <span class=na>class=</span><span class=s>&#34;TcpListener&#34;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;Param</span> <span class=na>name=</span><span class=s>&#34;Interface&#34;</span> <span class=na>value=</span><span class=s>&#34;127.0.0.1&#34;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;Param</span> <span class=na>name=</span><span class=s>&#34;Port&#34;</span> <span class=na>value=</span><span class=s>&#34;9418&#34;</span><span class=nt>/&gt;</span>
        <span class=nt>&lt;/Publisher&gt;</span>
        <span class=nt>&lt;Strategy</span> <span class=na>class=</span><span class=s>&#34;Random&#34;</span><span class=nt>/&gt;</span>
        <span class=nt>&lt;Logger</span> <span class=na>class=</span><span class=s>&#34;Filesystem&#34;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;Param</span> <span class=na>name=</span><span class=s>&#34;Path&#34;</span> <span class=na>value=</span><span class=s>&#34;logs&#34;</span><span class=nt>/&gt;</span>
        <span class=nt>&lt;/Logger&gt;</span>
    <span class=nt>&lt;/Test&gt;</span>
<span class=nt>&lt;/Peach&gt;</span>
</code></pre></div><p>Your git client used a different port to connect to the git server when we did
the capture than mine did. When you copy the xml file you will have to change
the values as indicated with comments so that peach knows what files to use.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Change to the correct files</span>
vim git.xml
peach git.xml
</code></pre></div><p>Peach is fuzzing the git protocol now! Good job you rock!</p></article></div></div></div></main><footer class=footer><div class="ax-l-i max-w-6xl"><nav class="flex items-center justify-center"><a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/about/>About</a></nav><div class="footer-social flex items-center justify-center mt-4"><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Twitter href=https://twitter.com/pdxjohnny><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Github href=https://github.com/pdxjohnny><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998.0C7.164.0.0 7.35.0 16.417.0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113.0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344.0.0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98.0 014.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406.0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836.0 15.998.0z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=LinkedIn href=https://www.linkedin.com/in/john-andersen-7a72b555/><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M29.692.0H2.308A2.31 2.31.0 000 2.308v27.384A2.31 2.31.0 002.308 32h27.384A2.31 2.31.0 0032 29.692V2.308A2.31 2.31.0 0029.692.0zM11.35 24.188H7.454V12.464h3.897v11.723zM9.402 10.863h-.025c-1.308.0-2.153-.9-2.153-2.025.0-1.15.872-2.026 2.205-2.026s2.153.875 2.18 2.026c0 1.125-.846 2.025-2.205 2.025zm16 13.324h-3.896v-6.272c0-1.576-.564-2.65-1.974-2.65-1.076.0-1.717.725-2 1.425-.103.25-.128.6-.128.95v6.547h-3.896V12.464h3.896v1.66c.518-.8 1.444-1.935 3.512-1.935 2.564.0 4.486 1.676 4.486 5.276v6.722z"/></svg></a></div><div class="footer-copyright text-sm text-center text-gray-500 mt-4">&#169; 2016-2020 pdxjohnny's blog</div><div class="text-sm sm:text-xs text-center text-gray-500 mt-2">Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a></div></div></footer><script src="/bundle.js?v=1594149815"></script></body></html>